<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰é¸¡å°¾é…’åˆ›å»ºå™¨ - Cybar</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/custom/cocktail-simulation.css">
    <!-- æ·»åŠ Google Fontsä»¥ä¿æŒä¸ä¸»é¡µä¸€è‡´ -->
    <link href="https://fonts.googleapis.com/css2?family=Electrolize&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* ä¸»é¡µæ ·å¼ä¸€è‡´æ€§ - Headeræ ·å¼ */
        header {
            background: linear-gradient(90deg, #1a1a2e, #0f3460, #1a1a2e);
            color: #00e5ff;
            padding: 1.5rem 1rem;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            border-bottom: 3px solid #00e5ff;
            box-shadow: 0 4px 20px rgba(0, 229, 255, 0.3);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            margin: 0;
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.7), 0 0 15px rgba(0, 229, 255, 0.5);
            letter-spacing: 3px;
        }

        header h1 a {
            color: white;
            text-decoration: none;
        }

        /* ç”¨æˆ·çŠ¶æ€æ ·å¼ - ä¸ä¸»é¡µä¸€è‡´ */
        #user-status {
            font-family: 'Electrolize', sans-serif;
            color: #00e5ff;
        }

        #user-status a {
            color: #00e5ff;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        #user-status a:hover {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.7);
        }

        /* æ ‡é¢˜æ ·å¼ - ä¸ä¸»é¡µä¸€è‡´ */
        h2,
        h3 {
            font-family: 'Orbitron', sans-serif;
            color: #00e5ff;
            border-bottom: 1px solid rgba(0, 229, 255, 0.5);
            padding-bottom: 10px;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* ä¸»è¦æ ‡é¢˜æ ·å¼ - ä¸ä¸»èœå•h2ä¸€è‡´ */
        main>h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.9rem;
            color: #00e5ff;
            border-bottom: 1px solid rgba(0, 229, 255, 0.5);
            padding-bottom: 12px;
            margin-bottom: 30px;
            letter-spacing: 1.5px;
            text-align: center;
        }

        /* ç¡®ä¿bodyä½¿ç”¨æ­£ç¡®çš„å­—ä½“ */
        /* è¡¨å•åŒºåŸŸæ ‡é¢˜æ ·å¼ */
        .form-section h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #00e5ff;
            border-bottom: 1px solid rgba(0, 229, 255, 0.5);
            padding-bottom: 10px;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        /* å­æ ‡é¢˜æ ·å¼ */
        .form-section h4,
        .recipe-ingredients h4,
        .recipe-steps h4,
        .recipe-info h4,
        .recipe-tips h4 {
            font-family: 'Orbitron', sans-serif;
            color: #00e5ff;
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
        }

        /* ç¡®ä¿bodyä½¿ç”¨æ­£ç¡®çš„å­—ä½“ */
        body {
            font-family: 'Electrolize', sans-serif;
        }

        /* AIæ™ºèƒ½è°ƒé…’å¸ˆåŠŸèƒ½æ ·å¼ */
        .ai-bartender-section {
            background-color: rgba(25, 25, 50, 0.5);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.9rem;
            margin: 0 0 10px 0;
            color: #00e5ff;
            border-bottom: 1px solid rgba(0, 229, 255, 0.5);
            padding-bottom: 12px;
            letter-spacing: 1.5px;
        }

        .section-subtitle {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .ai-bartender-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .ai-generate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .ai-generate-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5b52f0, #7c3aed);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .ai-generate-btn:disabled {
            background: linear-gradient(135deg, #374151, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-generate-btn .btn-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .ai-recipe-result {
            background-color: rgba(40, 40, 80, 0.6);
            border: 1px solid rgba(74, 144, 226, 0.4);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .recipe-header h3 {
            color: #4a90e2;
            margin: 0 0 10px 0;
        }

        .recipe-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .recipe-ingredients h4,
        .recipe-steps h4,
        .recipe-info h4,
        .recipe-tips h4 {
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 10px 0;
        }

        .ingredient-item-generated {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: rgba(60, 60, 120, 0.4);
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .recipe-steps ol {
            padding-left: 20px;
        }

        .recipe-steps li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .recipe-details {
            grid-column: span 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .taste-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .taste-label {
            min-width: 50px;
            font-size: 0.9rem;
        }

        .taste-meter {
            flex: 1;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .taste-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #7fb5ff);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .recipe-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .apply-recipe-btn,
        .regenerate-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-recipe-btn {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }

        .apply-recipe-btn:hover {
            background: linear-gradient(135deg, #059669, #10b981);
            transform: translateY(-2px);
        }

        .regenerate-btn {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }

        .regenerate-btn:hover {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            transform: translateY(-2px);
        }

        /* AIåˆ†æåŠŸèƒ½æ ·å¼ */
        .ai-analysis-section {
            background-color: rgba(25, 25, 50, 0.5);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-analysis-section h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #00e5ff;
            border-bottom: 1px solid rgba(0, 229, 255, 0.5);
            padding-bottom: 10px;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .ai-analyze-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .ai-analyze-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5b52f0, #7c3aed);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .ai-analyze-btn:disabled {
            background: linear-gradient(135deg, #374151, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-analysis-result {
            background-color: rgba(40, 40, 80, 0.6);
            border: 1px solid rgba(74, 144, 226, 0.4);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }

        .analysis-meta {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* è‡ªå®šä¹‰é¸¡å°¾é…’åˆ›å»ºå™¨ç‰¹å®šæ ·å¼ */
        .ingredient-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: rgba(25, 25, 50, 0.3);
        }

        .selected-ingredients {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #4a90e2;
            border-radius: 5px;
            background-color: rgba(25, 25, 50, 0.3);
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: rgba(40, 40, 80, 0.5);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .ingredient-item:hover {
            background-color: rgba(60, 60, 120, 0.5);
            transform: translateY(-2px);
        }

        .ingredient-details {
            display: flex;
            align-items: center;
        }

        .ingredient-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .ingredient-action {
            display: flex;
            align-items: center;
        }

        .ingredient-action button {
            margin-left: 5px;
            background: none;
            border: none;
            color: #4a90e2;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .ingredient-action button:hover {
            color: #7fb5ff;
        }

        .ingredient-action input {
            width: 60px;
            text-align: center;
            margin: 0 5px;
            background-color: rgba(30, 30, 60, 0.7);
            border: 1px solid #555;
            color: white;
            padding: 3px;
            border-radius: 3px;
        }

        .create-steps {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }

        .step-container {
            margin-bottom: 15px;
        }

        .step-textarea {
            width: 100%;
            padding: 10px;
            min-height: 60px;
            background-color: rgba(30, 30, 60, 0.7);
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            resize: vertical;
        }

        .add-step-btn {
            align-self: flex-start;
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .step-list {
            margin-top: 15px;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: rgba(40, 40, 80, 0.5);
            margin-bottom: 8px;
            border-radius: 5px;
        }

        .step-number {
            margin-right: 10px;
            background-color: #4a90e2;
            color: white;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .step-text {
            flex-grow: 1;
        }

        .step-remove {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            margin-left: 10px;
        }

        .summary-section {
            background-color: rgba(25, 25, 50, 0.5);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .abv-display {
            font-size: 1.5rem;
            text-align: center;
            color: #4a90e2;
            margin: 15px 0;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s ease;
        }

        .submit-btn:hover {
            background-color: #357abd;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* æ ‡ç­¾æ ·å¼ */
        .ingredient-tag {
            display: inline-block;
            padding: 3px 8px;
            background-color: rgba(74, 144, 226, 0.3);
            border: 1px solid #4a90e2;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .alert-banner {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }

        .alert-error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        /* åˆ†ç±»é€‰é¡¹å¡æ ·å¼ */
        .search-bar {
            margin-bottom: 10px;
        }

        .search-bar input {
            width: 100%;
            padding: 8px;
            background-color: rgba(30, 30, 60, 0.7);
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
        }

        .categories-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .category-tab {
            padding: 6px 10px;
            background-color: rgba(40, 40, 80, 0.5);
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-tab:hover {
            background-color: rgba(60, 60, 120, 0.5);
        }

        .category-tab.active {
            background-color: #4a90e2;
            border-color: #4a90e2;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .two-columns {
                flex-direction: column;
            }

            .column {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1><a href="/">Cybar</a></h1>
        <div id="user-status">
            <a href="/auth/login/">ç™»å½•</a> |
            <a href="/auth/register/">æ³¨å†Œ</a>
        </div>
    </header>
    <div id="login-prompt"
        style="display: none; margin-top: 15px; padding: 10px; background-color: #333; border: 1px solid #555; border-radius: 4px; text-align: center;">
        <h3 style="color: #00e5ff;">éœ€è¦ç™»å½•</h3>
        <p>è¯· <a href="/auth/login/" style="color: #00e5ff; text-decoration: underline;">ç™»å½•</a> ä»¥ä¿å­˜æ‚¨çš„è‡ªå®šä¹‰é¸¡å°¾é…’ã€‚</p>
    </div>

    <main>
        <!-- AIæ™ºèƒ½è°ƒé…’å¸ˆåŠŸèƒ½ -->
        <section class="ai-bartender-section">
            <div class="section-header">
                <h2>ğŸ¸ AIæ™ºèƒ½è°ƒé…’å¸ˆ</h2>
                <p class="section-subtitle">æ²¡æœ‰çµæ„Ÿï¼Ÿæ¥è¯•è¯•AIè°ƒé…’ï¼æè¿°æ‚¨æƒ³è¦çš„å£å‘³ï¼Œè®©AIä¸ºæ‚¨é‡èº«å®šåˆ¶é¸¡å°¾é…’é…æ–¹</p>
            </div>

            <div class="ai-bartender-form">
                <div class="form-group">
                    <label for="taste-description">ğŸ¯ å£å‘³æè¿°</label>
                    <textarea id="taste-description" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³è¦ä¸€æ¬¾æ¸…çˆ½çš„å¤æ—¥é¸¡å°¾é…’ï¼Œå¸¦æœ‰æŸ‘æ©˜é¦™å‘³ï¼Œä¸è¦å¤ªç”œï¼Œé…’ç²¾åº¦é€‚ä¸­..."
                        rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="occasion-select">ğŸ‰ é€‚ç”¨åœºåˆ</label>
                        <select id="occasion-select">
                            <option value="">è¯·é€‰æ‹©ï¼ˆå¯é€‰ï¼‰</option>
                            <option value="ä¼‘é—²èšä¼š">ä¼‘é—²èšä¼š</option>
                            <option value="æµªæ¼«çº¦ä¼š">æµªæ¼«çº¦ä¼š</option>
                            <option value="å•†åŠ¡å®´è¯·">å•†åŠ¡å®´è¯·</option>
                            <option value="å¤æ—¥æ¸…çˆ½">å¤æ—¥æ¸…çˆ½</option>
                            <option value="å†¬æ—¥æ¸©æš–">å†¬æ—¥æ¸©æš–</option>
                            <option value="å¼€èƒƒé…’">å¼€èƒƒé…’</option>
                            <option value="é¤åé…’">é¤åé…’</option>
                            <option value="æ·±å¤œå°é…Œ">æ·±å¤œå°é…Œ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="strength-select">ğŸ’ª é…’ç²¾å¼ºåº¦</label>
                        <select id="strength-select">
                            <option value="">è¯·é€‰æ‹©ï¼ˆå¯é€‰ï¼‰</option>
                            <option value="ä½åº¦">ä½åº¦ï¼ˆæ˜“å…¥å£ï¼‰</option>
                            <option value="ä¸­åº¦">ä¸­åº¦ï¼ˆå¹³è¡¡æ„Ÿï¼‰</option>
                            <option value="é«˜åº¦">é«˜åº¦ï¼ˆå¤ŸåŠ²é“ï¼‰</option>
                            <option value="æ— é…’ç²¾">æ— é…’ç²¾ï¼ˆmocktailï¼‰</option>
                        </select>
                    </div>
                </div>

                <button type="button" class="ai-generate-btn" id="ai-generate-btn">
                    <span class="btn-icon">ğŸ¤–</span>
                    <span class="btn-text">ç”ŸæˆAIé…æ–¹</span>
                    <span class="loading-spinner" style="display: none;">â³</span>
                </button>
            </div>

            <div class="ai-recipe-result" id="ai-recipe-result" style="display: none;">
                <div class="recipe-header">
                    <h3 id="generated-recipe-name"></h3>
                    <p id="generated-recipe-description"></p>
                </div>

                <div class="recipe-content">
                    <div class="recipe-ingredients">
                        <h4>ğŸ§ª åŸæ–™æ¸…å•</h4>
                        <div id="generated-ingredients"></div>
                    </div>

                    <div class="recipe-steps">
                        <h4>ğŸ“‹ åˆ¶ä½œæ­¥éª¤</h4>
                        <ol id="generated-steps"></ol>
                    </div>

                    <div class="recipe-details">
                        <div class="recipe-info">
                            <h4>ğŸ“Š å£å‘³ç‰¹å¾</h4>
                            <div id="taste-profile"></div>
                        </div>

                        <div class="recipe-tips">
                            <h4>ğŸ’¡ å°è´´å£«</h4>
                            <div id="recipe-tips"></div>
                        </div>
                    </div>
                </div>

                <div class="recipe-actions">
                    <button type="button" class="apply-recipe-btn" id="apply-recipe-btn">
                        âœ¨ åº”ç”¨åˆ°ä¸‹æ–¹è¡¨å•
                    </button>
                    <button type="button" class="regenerate-btn" id="regenerate-btn">
                        ğŸ”„ é‡æ–°ç”Ÿæˆ
                    </button>
                </div>
            </div>
        </section>

        <h2>è‡ªå®šä¹‰é¸¡å°¾é…’åˆ›å»ºå™¨</h2>
        <p>åˆ›å»ºæ‚¨ç‹¬ç‰¹çš„é¸¡å°¾é…’é…æ–¹ï¼Œå±•ç¤ºæ‚¨çš„åˆ›æ„</p>

        <div id="alert-container" class="alert-banner"></div>

        <form id="custom-cocktail-form">
            <div class="form-section">
                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="cocktail-name">é¸¡å°¾é…’åç§°</label>
                    <input type="text" id="cocktail-name" name="cocktail-name" required placeholder="ç»™æ‚¨çš„é¸¡å°¾é…’èµ·ä¸ªåå­—">
                </div>

                <div class="form-group">
                    <label for="cocktail-description">æè¿°</label>
                    <textarea id="cocktail-description" name="cocktail-description"
                        placeholder="æè¿°æ‚¨çš„é¸¡å°¾é…’çš„å£æ„Ÿç‰¹è‰²"></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>é€‰æ‹©åŸæ–™</h3>
                <div class="two-columns">
                    <div class="column">
                        <div class="form-group">
                            <label>å¯ç”¨åŸæ–™</label>
                            <div class="search-bar">
                                <input type="text" id="ingredient-search" placeholder="æœç´¢åŸæ–™...">
                            </div>
                            <div class="categories-tabs" id="ingredient-categories">
                                <button class="category-tab active" data-category="all">å…¨éƒ¨</button>
                                <button class="category-tab" data-category="base_alcohol">åŸºé…’</button>
                                <button class="category-tab" data-category="juice">æœæ±</button>
                                <button class="category-tab" data-category="syrup">ç³–æµ†</button>
                                <button class="category-tab" data-category="soda">ç¢³é…¸é¥®æ–™</button>
                                <button class="category-tab" data-category="garnish">è£…é¥°</button>
                                <button class="category-tab" data-category="other">å…¶ä»–</button>
                            </div>
                            <div class="ingredient-list" id="available-ingredients">
                                <div class="loading">åŠ è½½åŸæ–™ä¸­...</div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="form-group">
                            <label>å·²é€‰åŸæ–™</label>
                            <div class="selected-ingredients" id="selected-ingredients">
                                <p class="empty-message">å°šæœªé€‰æ‹©ä»»ä½•åŸæ–™</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section" id="abv-calculation-section">
                <h3>é…’ç²¾å«é‡è®¡ç®—</h3>
                <div class="abv-display">ä¼°è®¡é…’ç²¾åº¦: <span id="calculated-abv">0.0%</span></div>
            </div>

            <div class="form-section">
                <h3>åˆ¶ä½œæ­¥éª¤</h3>
                <div class="create-steps">
                    <div class="step-container">
                        <textarea class="step-textarea" id="step-input" placeholder="ä¾‹å¦‚: å°†æ‰€æœ‰åŸæ–™å€’å…¥è°ƒé…’æ¯ä¸­..."></textarea>
                        <button type="button" class="add-step-btn" id="add-step-btn">æ·»åŠ æ­¥éª¤</button>
                    </div>

                    <div class="step-list" id="step-list">
                    </div>
                </div>
            </div>

            <!-- AIåˆ†æåŠŸèƒ½ -->
            <div class="ai-analysis-section">
                <h3>ğŸ¤– AIå£å‘³åˆ†æ</h3>
                <p>è®©AIåˆ†ææ‚¨çš„é…æ–¹ï¼Œè·å¾—ä¸“ä¸šçš„å£å‘³è¯„ä»·å’Œæ”¹è¿›å»ºè®®</p>

                <button type="button" class="ai-analyze-btn" id="ai-analyze-btn" disabled>
                    <span class="btn-icon">ğŸ§ </span>
                    <span class="btn-text">åˆ†æå£å‘³ç‰¹å¾</span>
                    <span class="loading-spinner" style="display: none;">â³</span>
                </button>

                <div class="ai-analysis-result" id="ai-analysis-result" style="display: none;">
                    <h4>ğŸ“Š AIåˆ†æç»“æœ</h4>
                    <div class="analysis-content" id="analysis-content"></div>
                    <div class="analysis-meta" id="analysis-meta"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>é¢„è§ˆä¸åˆ›å»º</h3>
                <div class="summary-section">
                    <h4>é…æ–¹æ‘˜è¦</h4>
                    <div id="recipe-summary">
                        <p>å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºé…æ–¹æ‘˜è¦</p>
                    </div>

                    <button type="submit" class="submit-btn" id="create-cocktail-btn" disabled>åˆ›å»ºé¸¡å°¾é…’</button>
                </div>
            </div>
        </form>

        <div class="back-section">
            <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Cybar<br>made by 252</p>
    </footer>

    <script src="/js/global.js"></script>
    <script src="/custom/cocktail-debug.js"></script>
    <script src="/custom/cocktail-simulation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let ingredientsByCategory = {};
            let filteredIngredients = [];
            let selectedIngredients = [];
            let steps = [];
            let estimatedAbv = 0;
            let currentCategory = 'all';
            let searchTerm = '';
            const alertContainer = document.getElementById('alert-container');

            // è®¾ç½®åˆ†ç±»æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    filterAndRenderIngredients();
                });
            });

            // è®¾ç½®æœç´¢è¾“å…¥äº‹ä»¶
            document.getElementById('ingredient-search').addEventListener('input', function () {
                searchTerm = this.value.trim().toLowerCase();
                filterAndRenderIngredients();
            });

            // è·å–æ‰€æœ‰åŸæ–™
            fetch('/api/custom/ingredients')
                .then(response => response.json())
                .then(data => {
                    // å­˜å‚¨åŸå§‹åˆ†ç±»æ•°æ®
                    ingredientsByCategory = {};

                    // ç¡®ä¿æ•°æ®ç»“æ„æ­£ç¡®
                    if (data && data.ingredients && Array.isArray(data.ingredients)) {
                        data.ingredients.forEach(category => {
                            if (category.category && Array.isArray(category.items)) {
                                ingredientsByCategory[category.category] = category.items.map(item => {
                                    // ä¸ºæ¯ä¸ªåŸæ–™æ·»åŠ é¢œè‰²å±æ€§
                                    return {
                                        ...item,
                                        color: getColorForIngredient(item, category.category)
                                    };
                                });
                            }
                        });

                        // åˆå§‹åŒ–æ¸²æŸ“
                        filterAndRenderIngredients();
                    } else {
                        console.error('åŸæ–™æ•°æ®ç»“æ„ä¸æ­£ç¡®:', data);
                        showAlert('åŸæ–™æ•°æ®ç»“æ„ä¸æ­£ç¡®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                    }
                })
                .catch(error => {
                    console.error('è·å–åŸæ–™å¤±è´¥:', error);
                    showAlert('æ— æ³•åŠ è½½åŸæ–™æ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                });

            // ä¸ºåŸæ–™åˆ†é…é¢œè‰²
            function getColorForIngredient(ingredient, category) {
                // æ ¹æ®åˆ†ç±»åˆ†é…é¢œè‰²
                const categoryColors = {
                    'base_alcohol': '#ff9f1c', // æ©™è‰²è°ƒ - é…’ç²¾åŸºé…’
                    'juice': '#70d143',        // ç»¿è‰²è°ƒ - æœæ±
                    'syrup': '#ffcf56',        // é»„è‰²è°ƒ - ç³–æµ†
                    'soda': '#58d0ff',         // è“è‰²è°ƒ - ç¢³é…¸é¥®æ–™
                    'garnish': '#ff5a5a',      // çº¢è‰²è°ƒ - è£…é¥°ç‰©
                    'other': '#c78dff'         // ç´«è‰²è°ƒ - å…¶ä»–åŸæ–™
                };

                return categoryColors[category] || '#cccccc';
            }

            // è¿‡æ»¤å¹¶æ¸²æŸ“åŸæ–™åˆ—è¡¨
            function filterAndRenderIngredients() {
                // æ ¹æ®å½“å‰åˆ†ç±»å’Œæœç´¢è¯è¿‡æ»¤åŸæ–™
                filteredIngredients = [];

                Object.keys(ingredientsByCategory).forEach(category => {
                    if (currentCategory === 'all' || currentCategory === category) {
                        const categoryIngredients = ingredientsByCategory[category].filter(ingredient => {
                            // æœç´¢è¿‡æ»¤
                            if (searchTerm && !ingredient.name.toLowerCase().includes(searchTerm)) {
                                return false;
                            }

                            // è·³è¿‡å·²é€‰æ‹©çš„åŸæ–™
                            return !selectedIngredients.find(item => item.id === ingredient.id);
                        });

                        filteredIngredients = filteredIngredients.concat(categoryIngredients);
                    }
                });

                renderAvailableIngredients();
            }

            // æ¸²æŸ“å¯ç”¨åŸæ–™åˆ—è¡¨
            function renderAvailableIngredients() {
                const container = document.getElementById('available-ingredients');
                container.innerHTML = '';

                if (filteredIngredients.length === 0) {
                    container.innerHTML = '<p class="empty-message">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åŸæ–™</p>';
                    return;
                }

                filteredIngredients.forEach(ingredient => {
                    const item = document.createElement('div');
                    item.className = 'ingredient-item fade-in';
                    item.innerHTML = `
                        <div class="ingredient-details">
                            <div class="ingredient-color" style="background-color: ${ingredient.color}"></div>
                            <span>${ingredient.name} (${ingredient.abv}% ABV)</span>
                        </div>
                        <div class="ingredient-action">
                            <button type="button" class="add-ingredient-btn" data-id="${ingredient.id}">+</button>
                        </div>
                    `;

                    container.appendChild(item);

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    item.querySelector('.add-ingredient-btn').addEventListener('click', function () {
                        addIngredient(ingredient);
                    });
                });
            }

            // æ·»åŠ åŸæ–™
            function addIngredient(ingredient) {
                // åˆ›å»ºæ–°çš„é€‰ä¸­åŸæ–™å¯¹è±¡ï¼ŒåŒ…å«å®¹é‡å­—æ®µ
                const selectedIngredient = {
                    ...ingredient,
                    volume: 30 // é»˜è®¤30ml
                };

                selectedIngredients.push(selectedIngredient);
                renderSelectedIngredients();
                filterAndRenderIngredients(); // é‡æ–°è¿‡æ»¤ä»¥ç§»é™¤å·²é€‰æ‹©çš„
                updateAbvCalculation();
                updateSummary();
                checkFormValidity();
            }

            // æ¸²æŸ“å·²é€‰åŸæ–™
            function renderSelectedIngredients() {
                const container = document.getElementById('selected-ingredients');
                container.innerHTML = '';

                if (selectedIngredients.length === 0) {
                    container.innerHTML = '<p class="empty-message">å°šæœªé€‰æ‹©ä»»ä½•åŸæ–™</p>';
                    return;
                }

                selectedIngredients.forEach((ingredient, index) => {
                    const item = document.createElement('div');
                    item.className = 'ingredient-item fade-in';
                    item.innerHTML = `
                        <div class="ingredient-details">
                            <div class="ingredient-color" style="background-color: ${ingredient.color}"></div>
                            <span>${ingredient.name} (${ingredient.abv}% ABV)</span>
                        </div>
                        <div class="ingredient-action">
                            <button type="button" class="volume-btn volume-decrease" data-index="${index}">-</button>
                            <input type="number" min="5" max="1000" value="${ingredient.volume}" class="volume-input" data-index="${index}">
                            <span>${ingredient.unit || 'ml'}</span>
                            <button type="button" class="volume-btn volume-increase" data-index="${index}">+</button>
                            <button type="button" class="remove-ingredient-btn" data-index="${index}">Ã—</button>
                        </div>
                    `;

                    container.appendChild(item);

                    // æ·»åŠ äº‹ä»¶ç›‘å¬
                    item.querySelector('.volume-decrease').addEventListener('click', function () {
                        if (ingredient.volume > 5) {
                            ingredient.volume -= 5;
                            updateIngredientVolume(index, ingredient.volume);
                        }
                    });

                    item.querySelector('.volume-increase').addEventListener('click', function () {
                        if (ingredient.volume < 1000) {
                            ingredient.volume += 5;
                            updateIngredientVolume(index, ingredient.volume);
                        }
                    });

                    item.querySelector('.volume-input').addEventListener('change', function (e) {
                        let value = parseInt(e.target.value);
                        if (isNaN(value)) value = 30;
                        if (value < 5) value = 5;
                        if (value > 1000) value = 1000;
                        updateIngredientVolume(index, value);
                    });

                    item.querySelector('.remove-ingredient-btn').addEventListener('click', function () {
                        selectedIngredients.splice(index, 1);
                        renderSelectedIngredients();
                        filterAndRenderIngredients(); // é‡æ–°è¿‡æ»¤ä»¥æ˜¾ç¤ºç§»é™¤çš„åŸæ–™
                        updateAbvCalculation();
                        updateSummary();
                        checkFormValidity();
                    });
                });
            }

            // æ›´æ–°åŸæ–™å®¹é‡
            function updateIngredientVolume(index, volume) {
                selectedIngredients[index].volume = volume;
                document.querySelectorAll('.volume-input')[index].value = volume;
                updateAbvCalculation();
                updateSummary();
            }

            // æ›´æ–°ABVè®¡ç®—
            function updateAbvCalculation() {
                if (selectedIngredients.length === 0) {
                    estimatedAbv = 0;
                    document.getElementById('calculated-abv').textContent = '0.0%';
                    return;
                }

                let totalAlcoholVolume = 0;
                let totalVolume = 0;

                selectedIngredients.forEach(ingredient => {
                    totalAlcoholVolume += (ingredient.volume * (ingredient.abv / 100));
                    totalVolume += ingredient.volume;
                });

                estimatedAbv = totalAlcoholVolume / totalVolume * 100;
                document.getElementById('calculated-abv').textContent = estimatedAbv.toFixed(1) + '%';

                // å‘é€è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥è°ƒé…’æ¨¡æ‹Ÿå™¨æ›´æ–°é¢œè‰²
                document.dispatchEvent(new CustomEvent('abv-updated', {
                    detail: { abv: estimatedAbv }
                }));
            }

            // æ·»åŠ æ­¥éª¤
            document.getElementById('add-step-btn').addEventListener('click', function () {
                const stepInput = document.getElementById('step-input');
                const stepText = stepInput.value.trim();

                if (stepText) {
                    steps.push(stepText);
                    renderSteps();
                    stepInput.value = '';
                    updateSummary();
                    checkFormValidity();
                }
            });

            // æ¸²æŸ“æ­¥éª¤
            function renderSteps() {
                const stepList = document.getElementById('step-list');
                stepList.innerHTML = '';

                if (steps.length === 0) return;

                steps.forEach((step, index) => {
                    const stepItem = document.createElement('div');
                    stepItem.className = 'step-item fade-in';
                    stepItem.innerHTML = `
                        <div class="step-number">${index + 1}</div>
                        <div class="step-text">${step}</div>
                        <button type="button" class="step-remove" data-index="${index}">Ã—</button>
                    `;

                    stepList.appendChild(stepItem);

                    // æ·»åŠ åˆ é™¤äº‹ä»¶
                    stepItem.querySelector('.step-remove').addEventListener('click', function () {
                        steps.splice(index, 1);
                        renderSteps();
                        updateSummary();
                        checkFormValidity();
                    });
                });
            }

            // æ›´æ–°é…æ–¹æ‘˜è¦
            function updateSummary() {
                const summary = document.getElementById('recipe-summary');
                const cocktailName = document.getElementById('cocktail-name').value.trim();
                const cocktailDescription = document.getElementById('cocktail-description').value.trim();

                if (!cocktailName && selectedIngredients.length === 0) {
                    summary.innerHTML = '<p>å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºé…æ–¹æ‘˜è¦</p>';
                    return;
                }

                let summaryHTML = '';

                if (cocktailName) {
                    summaryHTML += `<h5>${cocktailName}</h5>`;
                } else {
                    summaryHTML += `<h5>æœªå‘½åé¸¡å°¾é…’</h5>`;
                }

                if (cocktailDescription) {
                    summaryHTML += `<p>${cocktailDescription}</p>`;
                }

                if (selectedIngredients.length > 0) {
                    summaryHTML += '<div class="ingredient-summary"><h6>åŸæ–™ï¼š</h6>';
                    selectedIngredients.forEach(ingredient => {
                        const displayUnit = ingredient.unit || 'ml';
                        summaryHTML += `<span class="ingredient-tag">${ingredient.name} ${ingredient.volume}${displayUnit}</span>`;
                    });
                    summaryHTML += '</div>';

                    summaryHTML += `<p>ä¼°è®¡é…’ç²¾åº¦: ${estimatedAbv.toFixed(1)}%</p>`;
                }

                if (steps.length > 0) {
                    summaryHTML += '<div class="steps-summary"><h6>æ­¥éª¤ï¼š</h6><ol>';
                    steps.forEach(step => {
                        summaryHTML += `<li>${step}</li>`;
                    });
                    summaryHTML += '</ol></div>';
                }

                summary.innerHTML = summaryHTML;
            }

            // æ£€æŸ¥è¡¨å•æœ‰æ•ˆæ€§
            function checkFormValidity() {
                const cocktailName = document.getElementById('cocktail-name').value.trim();
                const createButton = document.getElementById('create-cocktail-btn');
                const aiAnalyzeButton = document.getElementById('ai-analyze-btn');

                // éœ€è¦æœ‰åç§°ã€è‡³å°‘ä¸€ç§åŸæ–™å’Œè‡³å°‘ä¸€ä¸ªæ­¥éª¤
                const isValid = cocktailName && selectedIngredients.length > 0 && steps.length > 0;
                createButton.disabled = !isValid;

                // AIåˆ†ææŒ‰é’®åªéœ€è¦æœ‰åŸæ–™å³å¯
                const canAnalyze = selectedIngredients.length > 0;
                aiAnalyzeButton.disabled = !canAnalyze;
            }

            // ç›‘å¬åç§°è¾“å…¥æ›´æ–°æ‘˜è¦å’Œæ£€æŸ¥æœ‰æ•ˆæ€§
            document.getElementById('cocktail-name').addEventListener('input', function () {
                updateSummary();
                checkFormValidity();
            });

            document.getElementById('cocktail-description').addEventListener('input', function () {
                updateSummary();
            });

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            function showAlert(message, type) {
                alertContainer.className = `alert-banner alert-${type}`;
                alertContainer.textContent = message;
                alertContainer.style.display = 'block';

                setTimeout(() => {
                    alertContainer.style.display = 'none';
                }, 5000);
            }

            // AIå£å‘³åˆ†æåŠŸèƒ½
            document.getElementById('ai-analyze-btn').addEventListener('click', async function () {
                const button = this;
                const btnText = button.querySelector('.btn-text');
                const spinner = button.querySelector('.loading-spinner');
                const resultContainer = document.getElementById('ai-analysis-result');
                const analysisContent = document.getElementById('analysis-content');
                const analysisMeta = document.getElementById('analysis-meta');

                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                button.disabled = true;
                btnText.textContent = 'æ­£åœ¨åˆ†æ...';
                spinner.style.display = 'inline';

                // éšè—ä¹‹å‰çš„ç»“æœ
                resultContainer.style.display = 'none';

                try {
                    // å‡†å¤‡æ•°æ®
                    const cocktailData = {
                        name: document.getElementById('cocktail-name').value.trim() || 'æœªå‘½åé¸¡å°¾é…’',
                        description: document.getElementById('cocktail-description').value.trim(),
                        ingredients: selectedIngredients,
                        steps: steps
                    };

                    // è°ƒç”¨AIåˆ†æAPI
                    const response = await fetch('/api/custom/analyze-flavor?t=' + Date.now(), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify(cocktailData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // æ˜¾ç¤ºåˆ†æç»“æœ
                        analysisContent.textContent = result.analysis;

                        // æ˜¾ç¤ºåˆ†ææ—¶é—´
                        const analysisTime = new Date(result.analyzedAt).toLocaleString('zh-CN', {
                            timeZone: 'Asia/Shanghai',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        analysisMeta.textContent = `åˆ†ææ—¶é—´: ${analysisTime}`;

                        // æ˜¾ç¤ºç»“æœå®¹å™¨
                        resultContainer.style.display = 'block';

                        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                        resultContainer.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });

                        showAlert('AIå£å‘³åˆ†æå®Œæˆï¼', 'success');
                    } else {
                        // å¤„ç†é”™è¯¯
                        let errorMessage = result.message || 'AIåˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';

                        // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                        if (result.error === 'API_AUTH_ERROR') {
                            errorMessage = 'AIæœåŠ¡é…ç½®é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        } else if (result.error === 'RATE_LIMIT_ERROR') {
                            errorMessage = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                        } else if (result.error === 'TIMEOUT_ERROR') {
                            errorMessage = 'AIåˆ†æè¶…æ—¶ï¼Œè¯·ç¨åå†è¯•';
                        }

                        showAlert(errorMessage, 'error');
                    }
                } catch (error) {
                    console.error('AIåˆ†æè¯·æ±‚å¤±è´¥:', error);
                    showAlert('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = selectedIngredients.length === 0;
                    btnText.textContent = 'åˆ†æå£å‘³ç‰¹å¾';
                    spinner.style.display = 'none';
                }
            });

            // AIæ™ºèƒ½è°ƒé…’å¸ˆåŠŸèƒ½
            document.getElementById('ai-generate-btn').addEventListener('click', async function () {
                const button = this;
                const btnText = button.querySelector('.btn-text');
                const spinner = button.querySelector('.loading-spinner');
                const resultContainer = document.getElementById('ai-recipe-result');

                // è·å–ç”¨æˆ·è¾“å…¥
                const tasteDescription = document.getElementById('taste-description').value.trim();
                const occasion = document.getElementById('occasion-select').value;
                const alcoholStrength = document.getElementById('strength-select').value;

                // éªŒè¯è¾“å…¥
                if (!tasteDescription) {
                    showAlert('è¯·æè¿°æ‚¨æƒ³è¦çš„å£å‘³ç‰¹å¾', 'error');
                    return;
                }

                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                button.disabled = true;
                btnText.textContent = 'AIæ­£åœ¨åˆ›ä½œ...';
                spinner.style.display = 'inline';

                // éšè—ä¹‹å‰çš„ç»“æœ
                resultContainer.style.display = 'none';

                try {
                    // è°ƒç”¨AIç”Ÿæˆé…æ–¹API
                    const response = await fetch('/api/custom/generate-recipe?t=' + Date.now(), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({
                            tasteDescription,
                            occasion,
                            alcoholStrength
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        displayGeneratedRecipe(result.recipe);
                        resultContainer.style.display = 'block';

                        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                        resultContainer.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });

                        showAlert('AIé…æ–¹ç”ŸæˆæˆåŠŸï¼', 'success');
                    } else {
                        let errorMessage = result.message || 'AIé…æ–¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';

                        if (result.error === 'API_AUTH_ERROR') {
                            errorMessage = 'AIæœåŠ¡é…ç½®é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        } else if (result.error === 'RATE_LIMIT_ERROR') {
                            errorMessage = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
                        } else if (result.error === 'TIMEOUT_ERROR') {
                            errorMessage = 'AIç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨åå†è¯•';
                        }

                        showAlert(errorMessage, 'error');
                    }
                } catch (error) {
                    console.error('AIé…æ–¹ç”Ÿæˆè¯·æ±‚å¤±è´¥:', error);
                    showAlert('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    btnText.textContent = 'ç”ŸæˆAIé…æ–¹';
                    spinner.style.display = 'none';
                }
            });

            // æ˜¾ç¤ºç”Ÿæˆçš„é…æ–¹
            function displayGeneratedRecipe(recipe) {
                // è®¾ç½®åŸºæœ¬ä¿¡æ¯
                document.getElementById('generated-recipe-name').textContent = recipe.name || 'æœªå‘½åé…æ–¹';
                document.getElementById('generated-recipe-description').textContent = recipe.description || '';

                // æ˜¾ç¤ºåŸæ–™
                const ingredientsContainer = document.getElementById('generated-ingredients');
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    ingredientsContainer.innerHTML = recipe.ingredients.map(ing => {
                        // ä½¿ç”¨åŸæ–™æœ¬èº«å®šä¹‰çš„å•ä½ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®åŸæ–™ç±»å‹æ¨æ–­å•ä½
                        let unit = ing.unit || 'ml';
                        if (!ing.unit) {
                            if (ing.category === 'garnish') {
                                unit = 'ä¸ª';
                            } else if (ing.name.includes('è‹¦ç²¾') || ing.name.includes('è¾£æ¤’é…±')) {
                                unit = 'æ»´';
                            } else if (ing.name.includes('ç›') || ing.name.includes('èƒ¡æ¤’') || ing.name.includes('ç²‰')) {
                                unit = 'å…‹';
                            } else if (ing.name.includes('ç‰‡') || ing.name.includes('è½®')) {
                                unit = 'ç‰‡';
                            }
                        }

                        return `
                            <div class="ingredient-item-generated">
                                <span>${ing.name}</span>
                                <span>${ing.volume}${unit} (${ing.abv}%)</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    ingredientsContainer.innerHTML = '<p>æš‚æ— åŸæ–™ä¿¡æ¯</p>';
                }

                // æ˜¾ç¤ºæ­¥éª¤
                const stepsContainer = document.getElementById('generated-steps');
                if (recipe.steps && recipe.steps.length > 0) {
                    stepsContainer.innerHTML = recipe.steps.map(step => `<li>${step}</li>`).join('');
                } else {
                    stepsContainer.innerHTML = '<li>æš‚æ— åˆ¶ä½œæ­¥éª¤</li>';
                }

                // æ˜¾ç¤ºå£å‘³ç‰¹å¾
                const tasteProfileContainer = document.getElementById('taste-profile');
                if (recipe.taste_profile) {
                    const profile = recipe.taste_profile;
                    tasteProfileContainer.innerHTML = `
                        <div class="taste-bar">
                            <span class="taste-label">ç”œåº¦</span>
                            <div class="taste-meter">
                                <div class="taste-fill" style="width: ${(profile.sweetness || 0) * 20}%"></div>
                            </div>
                            <span>${profile.sweetness || 0}/5</span>
                        </div>
                        <div class="taste-bar">
                            <span class="taste-label">é…¸åº¦</span>
                            <div class="taste-meter">
                                <div class="taste-fill" style="width: ${(profile.sourness || 0) * 20}%"></div>
                            </div>
                            <span>${profile.sourness || 0}/5</span>
                        </div>
                        <div class="taste-bar">
                            <span class="taste-label">è‹¦åº¦</span>
                            <div class="taste-meter">
                                <div class="taste-fill" style="width: ${(profile.bitterness || 0) * 20}%"></div>
                            </div>
                            <span>${profile.bitterness || 0}/5</span>
                        </div>
                        <div class="taste-bar">
                            <span class="taste-label">çƒˆåº¦</span>
                            <div class="taste-meter">
                                <div class="taste-fill" style="width: ${(profile.strength || 0) * 20}%"></div>
                            </div>
                            <span>${profile.strength || 0}/5</span>
                        </div>
                    `;
                } else {
                    tasteProfileContainer.innerHTML = '<p>æš‚æ— å£å‘³ç‰¹å¾æ•°æ®</p>';
                }

                // æ˜¾ç¤ºå°è´´å£«
                const tipsContainer = document.getElementById('recipe-tips');
                let tipsHTML = '';
                if (recipe.tips) {
                    tipsHTML += `<p><strong>è°ƒåˆ¶è´´å£«ï¼š</strong>${recipe.tips}</p>`;
                }
                if (recipe.glassware) {
                    tipsHTML += `<p><strong>æ¨èæ¯å…·ï¼š</strong>${recipe.glassware}</p>`;
                }
                if (recipe.garnish) {
                    tipsHTML += `<p><strong>è£…é¥°å»ºè®®ï¼š</strong>${recipe.garnish}</p>`;
                }
                if (recipe.isDemo) {
                    tipsHTML += `<p style="color: #f59e0b;"><strong>âš ï¸ æ¼”ç¤ºæ¨¡å¼ï¼š</strong>è¿™æ˜¯æ¼”ç¤ºé…æ–¹ï¼Œé…ç½®APIå¯†é’¥åå¯è·å¾—çœŸå®AIç”Ÿæˆçš„é…æ–¹</p>`;
                }
                tipsContainer.innerHTML = tipsHTML || '<p>æš‚æ— é¢å¤–ä¿¡æ¯</p>';

                // å­˜å‚¨å½“å‰é…æ–¹ä¾›åº”ç”¨åŠŸèƒ½ä½¿ç”¨
                window.currentGeneratedRecipe = recipe;
            }

            // åº”ç”¨ç”Ÿæˆçš„é…æ–¹åˆ°ä¸Šæ–¹è¡¨å•
            document.getElementById('apply-recipe-btn').addEventListener('click', function () {
                if (!window.currentGeneratedRecipe) {
                    showAlert('æ²¡æœ‰å¯åº”ç”¨çš„é…æ–¹', 'error');
                    return;
                }

                const recipe = window.currentGeneratedRecipe;

                // åº”ç”¨åŸºæœ¬ä¿¡æ¯
                document.getElementById('cocktail-name').value = recipe.name || '';
                document.getElementById('cocktail-description').value = recipe.description || '';

                // åº”ç”¨åŸæ–™ï¼ˆéœ€è¦è½¬æ¢æ ¼å¼ï¼‰
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    selectedIngredients = recipe.ingredients.map(ing => {
                        // ä½¿ç”¨åŸæ–™æœ¬èº«å®šä¹‰çš„å•ä½ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®åŸæ–™ç±»å‹æ¨æ–­å•ä½
                        let unit = ing.unit || 'ml';
                        if (!ing.unit) {
                            if (ing.category === 'garnish') {
                                unit = 'ä¸ª';
                            } else if (ing.name.includes('è‹¦ç²¾') || ing.name.includes('è¾£æ¤’é…±')) {
                                unit = 'æ»´';
                            } else if (ing.name.includes('ç›') || ing.name.includes('èƒ¡æ¤’') || ing.name.includes('ç²‰')) {
                                unit = 'å…‹';
                            } else if (ing.name.includes('ç‰‡') || ing.name.includes('è½®')) {
                                unit = 'ç‰‡';
                            }
                        }

                        return {
                            name: ing.name,
                            volume: parseInt(ing.volume) || 0,
                            abv: parseFloat(ing.abv) || 0,
                            unit: unit,
                            id: ing.name.toLowerCase().replace(/\s+/g, '_'),
                            color: '#ff6b6b' // é»˜è®¤é¢œè‰²
                        };
                    });
                    renderSelectedIngredients();
                    updateAbvCalculation();
                }

                // åº”ç”¨æ­¥éª¤
                if (recipe.steps && recipe.steps.length > 0) {
                    steps = [...recipe.steps];
                    renderSteps();
                }

                // æ›´æ–°æ‘˜è¦å’Œæ£€æŸ¥æœ‰æ•ˆæ€§
                updateSummary();
                checkFormValidity();

                showAlert('é…æ–¹å·²åº”ç”¨åˆ°è¡¨å•ä¸­ï¼', 'success');

                // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
                document.getElementById('custom-cocktail-form').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            });

            // é‡æ–°ç”Ÿæˆé…æ–¹
            document.getElementById('regenerate-btn').addEventListener('click', function () {
                document.getElementById('ai-generate-btn').click();
            });

            // æäº¤è¡¨å•
            document.getElementById('custom-cocktail-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ç™»å½•
                try {
                    const authResponse = await fetch('/api/auth/status');
                    const authData = await authResponse.json();

                    if (!authData.loggedIn) {
                        showAlert('è¯·å…ˆç™»å½•ä»¥ä¿å­˜æ‚¨çš„é¸¡å°¾é…’é…æ–¹', 'error');
                        return;
                    }

                    // è·å–è¡¨å•æ•°æ®
                    const cocktailName = document.getElementById('cocktail-name').value.trim();
                    const cocktailDescription = document.getElementById('cocktail-description').value.trim();

                    // åˆ›å»ºè¦æäº¤çš„æ•°æ®å¯¹è±¡
                    const cocktailData = {
                        name: cocktailName,
                        description: cocktailDescription,
                        ingredients: selectedIngredients,
                        steps: steps,
                        estimatedAbv: parseFloat(estimatedAbv.toFixed(1))
                    };

                    // æäº¤åˆ°æœåŠ¡å™¨
                    const response = await fetch('/api/custom/cocktails', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(cocktailData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showAlert('é¸¡å°¾é…’åˆ›å»ºæˆåŠŸï¼', 'success');
                        // é‡ç½®è¡¨å•
                        document.getElementById('cocktail-name').value = '';
                        document.getElementById('cocktail-description').value = '';
                        selectedIngredients = [];
                        steps = [];
                        renderSelectedIngredients();
                        filterAndRenderIngredients();
                        renderSteps();
                        updateAbvCalculation();
                        updateSummary();
                        checkFormValidity();

                        // è·³è½¬åˆ°é…æ–¹é¡µé¢
                        setTimeout(() => {
                            window.location.href = '/recipes/';
                        }, 2000);
                    } else {
                        showAlert(result.message || 'åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    }
                } catch (error) {
                    console.error('æäº¤é…æ–¹æ—¶å‡ºé”™:', error);
                    showAlert('æäº¤è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            });

            // åˆå§‹æ›´æ–°
            updateSummary();
            checkFormValidity();
        });
    </script>
</body>

</html>